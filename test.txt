Системная постановка. Проект АИС "Мосбилет". Доработка модуля Театры. Миллион призов: Начисление баллов кэшбек и списание баллов
 UPBDEV-1453 - Лояльность: Миллион призов Подготовка СП 
•	UPBDEV-1453 - Лояльность: Миллион призов Подготовка СП
•  
•  1. История изменений 
•  3. Площадки 
•  4. Функция доступна для ролей пользователей Системы 
•  5. Навигационные цепочки 
•  6. Общая реализация 
•	6.1 Доработки в БД и конфигурационных файлах Мосбилет
•	6.2 Метод начисления баллов в Миллион призов
•	6.3 Метод проверки транзакции в Миллион призов
•	6.4 Метод получения баланса баллов в Миллион призов
•	6.5 Метод предварительного расчета баллов, которые могут быть начислены за заказ
•	6.6 Метод списания и отмены списания баллов
•	6.7 Общий алгоритм взаимодействия Мосбилет, покупателя и Миллион призов
•	6.8 Алгоритм начисления баллов
•	6.8 Алгоритм списания баллов
•	6.9 Изменения в интерфейсах Мосбилет
•  7. Описание интеграции с внешними системами 
•	7.1 Метод POST cashback/get API Миллион призов
•	7.2 Метод POST billing/heckTransaction API Миллион призов
•	7.3 Метод POST /billing/getUserLimitBalanceAllPoints API Миллион призов
•	7.4 Метод POST /cashback/precalculation API Миллион призов
•	7.5 Метод POST /billing/transaction API Миллион призов
•  8. Описание алгоритма 
•	8.1 Общий алгоритм взаимодействия Мосбилет, покупателя и Миллион призов
•	8.2 Алгоритм начисления баллов
•	8.3 Алгоритм списания баллов
•	8.4 Алгоритм определения event Миллион призов
•	8.5 Алгоритм определения максимальной скидки на заказ
•  9. Критерии приемки 
•  10. ERD и описание атрибутов 
•  11. Связанные объекты/ссылки 
1.    История изменений

Исполнитель	Ответственный	Статус	Версия	Дата версии	Изменения
Денис Цитко 
	В РАБОТЕ	1.1	12 сент. 2025 г. 	
					
2.    Термины и сокращения
Список терминов, используемых в настоящем документе более одного раза приведен в Таблица 1. Глоссарий.
№	Термин	Сокращение	Описание
1      	АИС «Мосбилет»	Система	Автоматизированная информационная система «Московская билетная система в сфере культуры»
2	Миллион призов	Миллион призов	Городская программа лояльности Правительства Москвы, где активные участники московских проектов могут обменивать полученные баллы на товары и услуги от партнеров.
3	mos.ru
мос.ру	Официальный портал Мэра и Правительства Москвы
4	Учетная запись	УЗ	Учетная запись пользователя
3. Площадки
В рамках данной СП разрабатывается функционал для театральных мероприятий
4.    Функция доступна для ролей пользователей Системы
Просмотр баланса баллов и получение баллов за покупку билетов доступно только покупателям, авторизованным в mos.ru и имеющим подтвержденную УЗ (в СУДИР trusted = true)
5.    Навигационные цепочки
При формировании заказа: Главная страница/Выбор мероприятия/Выбор события/Выбор мест (если применимо)/Оформление заказа
6.    Общая реализация
6.1 Доработки в БД и конфигурационных файлах Мосбилет
Новая таблица public.mp_users:
Таблица необходима для хранения дополнительной информации о пользователях, которым зачисляются баллы в рамках Миллиона призов. Таблица должна содержать следующие поля:
•	id int not null - id записи
•	sso_id nvarchar(255) not null - sso_id покупателя
•	balance int nullable - баланс баллов покупателя в Миллион призов
•	has_agreement boolean not null - признак согласие на участие в программе лояльности

Новая таблица public.user_million_prizes_cashback:
Таблица необходима для хранения транзакций начисления баллов для пользователя. Таблица должна содержать следующие поля:
•	id int not null - id записи
•	mp_user_id int not null - ссылка на запись в таблице public.mp_users
•	item_id int not null - ссылка на элемент заказа (билет), за который начисляются баллы в разрезе заказа
•	order_id int not null - ссылка на заказ
•	amount int not null - сумма баллов, которые начисляются или списываются за указанный элемент заказа
•	date_added_local datetime not null - дата в время добавления записи
•	state nvarchar(255) not null - статус записи, при создании записи проставляется NEW, при завершении начисления ADDED, если начисление не будет производиться - CANCELED
•	date_added_mp datetime nullable - дата перевода записи в статус ADDED
•	item_type nvarchar(255) not null - тип элемента заказа (TICKET, PROVIDER, RENTAL_PROVIDER, PRODUCT, MEMBERSHIP_TICKET, EXCURSION_TICKET)
•	charge_id nvarchar(255) not null - uuid транзакции, заполняется при создании записи
Новая таблица public.user_million_prizes_discount:
Таблица необходима для хранения информации о скидках за счет баллов по всем элементам заказа. Таблица должна содержать следующие поля:
•	id int not null - id записи
•	user_million_prizes_transaction_id int not null - связь с таблицей public.user_million_prizes_transaction
•	mp_user_id int not null - ссылка на запись в таблице public.mp_users
•	item_id int not null - ссылка на элемент заказа (билет), за который начисляются баллы в разрезе заказа
•	full_price decimal not null - стоимость элемента заказа в рублях без учета скидки
•	price decimal not null - стоимость элемента заказа в рублях с учетом скидки
•	discount decimal not null - сумма скидки на элемент заказа в рублях
•	date_added_local datetime not null - дата в время добавления записи
•	state nvarchar(255) not null - статус записи, при завершении списания ADDED (запись сразу создается в этом статусе), при отмене списания - CANCELED
•	item_type nvarchar(255) not null - тип элемента заказа (TICKET, PROVIDER, RENTAL_PROVIDER, PRODUCT, MEMBERSHIP_TICKET, EXCURSION_TICKET)
Новая таблица public.user_million_prizes_transaction:
Таблица необходима для хранения транзакций списания баллов для пользователя по заказу в целом. Таблица должна содержать следующие поля:
•	id int not null - id записи
•	mp_user_id int not null - ссылка на запись в таблице public.mp_users
•	order_id int not null - ссылка на заказ
•	full_price decimal not null - стоимость заказа в рублях без учета скидки
•	price decimal not null - стоимость заказа в рублях с учетом скидки
•	discount decimal not null - сумма скидки за весь заказ в рублях
•	date_added_local datetime not null - дата и время добавления записи
•	state nvarchar(255) not null - статус записи, при завершении списания ADDED (запись сразу создается в этом статусе), при отмене списания - CANCELED
•	charge_id nvarchar(255) not null - uuid транзакции, заполняется при создании записи (одинаковая для всех элементов с одинаковым order_id)
Новая таблица crm.million_prizes_settings
Таблица необходима для хранения настроек начисления и списания баллов в разрезе учреждений (museum), мероприятий (event) и событий (perfomance):
•	item_id int not null - id учреждения, мероприятия или события (в зависимости от item_type)
•	item_type int not null - тип настройки (MUSEUM, EVENT, PERFORMACE)
•	million_prizes_event varchar nullable - event миллиона призов для начисления баллов
•	max_discount int nullable - максимальная скидка за баллы на заказ
Подробнее новые таблицы и поля описаны в п. 10.
6.2 Метод начисления баллов в Миллион призов
Для начисления баллов используется метод POST cashback/get API Миллион призов. Описание метода в п. 7.1
В параметрах метода передаются chargeId для дедубликации, event_name и event_start_date (формат UTC) и event Миллиона призов, который определяется в соответствии с алгоритмом в п. 8.3
6.3 Метод проверки транзакции в Миллион призов
Для проверки транзакции используется метод POST billing/heckTransaction API Миллион призов. Описание метода в п. 7.2
Проверка транзакции осуществляется по chargeId
6.4 Метод получения баланса баллов в Миллион призов
Для получения баланса городских баллов покупателя используется метод POST /billing/getUserLimitBalanceAllPoints API Миллион призов. Описание метода в п. 7.3
6.5 Метод предварительного расчета баллов, которые могут быть начислены за заказ
Для предварительного расчета баллов, которые могут быть начислены за заказ используется метод POST /cashback/precalculation API Миллион призов. Описание метода в п. 7.4
В теле запроса метода передается массив элементов заказа (id, стоимость), в теле ответа передается массив элементов заказа с распределенными по ним баллами с учётом лимита пользователя, которые могут быть начислены за заказ (id, стоимость, количество баллов) и общее количество баллов, которые могут быть начислены за заказ (совпадает с суммой баллов по всем элементам заказа).
6.6 Метод списания и отмены списания баллов
Для списания и отмены списания баллов используется метод POST /billing/transaction API Миллион призов. Факт списания или отмены списания (начисления) баллов регулируется настройкой event в методе. Описание метода в п. 7.5
6.7 Общий алгоритм взаимодействия Мосбилет, покупателя и Миллион призов
Описание алгоритма приведено в формате диаграммы последовательностей в п. 8.1
6.8 Алгоритм начисления баллов
Описания алгоритма начисления баллов представлено в п. 8.2
В рамках алгоритма используется алгоритм определения события Миллион призов, который описан в п. 8.3
6.8 Алгоритм списания баллов
Описания алгоритма начисления баллов представлено в п. 8.4
В рамках алгоритма используется алгоритм определения максимальное скидки на заказ, который описан в п. 8.5
6.9 Изменения в интерфейсах Мосбилет
TODO
1. Отображать баланс баллов, баллы отображать фиолетовые
2. Отображать сколько баллов начислится за за заказ (возможно с разбивкой по элементам заказа)
3. Пользователь не выбирает сколько баллов списать. Списывается максимальное возможное количество баллов.
4. Скидка должна распределяться по билетам заказа и это должно быть видно в чеке (цены билетов в чеке отображаются уже со скидкой - округление до рублей)
5. Какая-то галка с согласием на участие в программе лояльности

7.    Описание интеграции с внешними системами
7.1 Метод POST cashback/get API Миллион призов

Показатель	Значение
Направление вызова	от Мосбилет к Миллион призов
Тип API	RESTfull API
Авторизация	basic
METHOD url	POST cashback/get
Атрибуты запроса метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	key	string	да	Ключ партнера	
2	ssoId	string	да	Идентификатор пользователя	 sso_ticket_link.sso_id where binding_type = PURCHASER
3	price	number	да	Стоимость элемента заказа	 pos.tickets.price
4	event	string	да	Название события 	 crm.million_prizes_settings.million_prizes_event (определяется по алгоритму в п. 8.3)
5	chargeId	string	нет	Ид транзакции партнера	 public.user_million_prizes_cashback.charge_id
6	params	object	нет	JSON объект дополнительных параметров	
 6.1	event_name	string	 нет	Название мероприятия	 crm.event.name
 6.2	event_start_datetime	string	 нет	Дата проведения мероприятия	 crm.event.start_date
Пример запроса
{
  "key": "ключ партнера",
  "ssoId": "SSOID",
  "price": 5000,
  "event": "event_name",
  "chargeId": "id транзакции для кешбэка",
  "params": {
    "event_name": "название мероприятия",
    "event_start_datetime": "дата проведения мероприятия"
  }
}
Атрибуты тела ответа метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	execTime	string	да	Время выполнения	
2	errorCode	integer	да	Код ошибки	
3	errorMessage	string	да	Текстовое пояснение ошибки	
4	requestId	string	да	Уникальный идентификатор запроса	
5	result.message	string	да	Сообщение о начислении баллов	  
6	result.cashbackId	string	да	ID начисления	
7	result.points	integer	да	Баллы, начисленные пользователю	 public.user_million_prizes_cashback.amount

Пример ответа:
{
  "execTime": "0.098",
  "errorCode": 0,
  "errorMessage": "",
  "requestId": "dcafd84cea069406577904667b27f19f",
  "result": {
    "message": "Начислено 1000 баллов",
    "cashbackId": "id начисления",
    "points": 1000
  }
}
Возможные ошибки:
Код	Текст ошибки	Комментарий
401	Ошибка авторизации	Ошибка авторизации партнёра
5112	Некорректное значение переданного (ssoId)	Некорректный ssoId
5225	Возникает при внутренней ошибке сервиса	
7300	Некорректный ключ	Используется неверный ключ доступа
7302	Неизвестное событие	Переданный event не зарегистрирован для данного key
7303	Для данного event отключена возможность указывать баллы для начисления в поле points. Поле должно быть пустым.	Передача points запрещена настройками для данного event
7304	Текст начисления не может быть пустым	Если вдруг у события не был задан текст для отображения в истории (для старых событий)
7306	Вы превысили количество баллов, доступных для начисления за одну операцию.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7307	Вы превысили количество баллов, доступных для начисления за всё время.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7308	Необходимо указать параметры шаблона для текста начисления	Для указанного event отмечен флаг "Партнёр должен передавать параметры шаблона для текста начисления"
7309	Необходимо указать идентификатор начисления	Для указанного event необходимо указать chargeId, или запросить разрешение не передавать ID начисления
7310	Операция с таким идентификатором уже была проведена	Для указанного key и chargeId уже есть операция
7312	Невозможно начислить баллы! Пользователю SSOID: %s уже были ранее начислены баллы за событие: %s. Данное событие не поддерживает многоразовые начисления, возможно только однократное начисление.	Для указанного event запрещены множественные начисления (разрешено только 1 начисление) на одного пользователя
7313	Невозможно начислить баллы! Количество баллов для начисления должно быть больше 0.	
7314	Дополнительная информация о событии не заполнена	Не должно возникать таких случаев
7315	Дополнительная информация о партнёре не заполнена	Не должно возникать таких случаев
7316	Для данного event отключена возможность указывать дату начисления	
7317	Для данного event отключена возможность указывать параметры шаблона для текста начисления. Поле params должно быть пустым.	
7318	Вы превысили количество баллов, доступных для начисления за день.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7319	Вы превысили количество баллов, доступных для начисления за неделю.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7320	Вы превысили количество баллов, доступных для начисления за месяц.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7321	Необходимо указать параметр %s шаблона для текста начисления	Для указанного event отмечен флаг "Партнёр должен передавать параметры шаблона для текста начисления"
7322	Неверный формат даты начисления	должна быть в формате ISO 8601 с указанием временной зоны (например 2022-10-24T12:02:17+03:00)
7323	Вы заблокированы	Необходимо попросить разблокировать
7333	Не удалось добавить начисление в очередь	
7344	Событие неактивно	
7345	Событие недоступно из-за установленных временных рамок	
18330	Параметр ssoId должен быть uuid	Некорректный uuid
18369	Кешбэк с таким именем не найден	
18370	Превышен лимит начисления кешбэка в этом месяце	
18371	Для расчета кешбэка параметр price должен быть больше 0	
18372	Превышен лимит начисления кешбэка в этом году	
18373	Превышен лимит начислений кешбека для переданного события	
18374	Превышен дневной лимит начислений кешбека для партнера	
18375	Превышен месячный лимит начислений кешбека для партнера	
18376	Превышен лимит начислений кешбека для партнера	
18377	Кешбек для данного события выключен	
18378	Ошибка при начислении баллов. Проверьте полноту и корректность данных в личном кабинете mos.ru.
Нет данных о возрасте в личном кабинете либо не удалось их получить
18379	Ошибка при начислении баллов. Проверьте полноту и корректность данных в личном кабинете mos.ru.
Нет данных по уровню учетной записи в личном кабинете либо не удалось их получить
18380	Ошибка при начислении баллов. Требуемый уровень учетной записи «%», ваш уровень «%». Повысьте уровень учетной записи в личном кабинете на mos.ru. Требуемый возраст % лет.	
18381	Ошибка при начислении баллов. Требуемый возраст % лет.	
18384	Ошибка при начислении баллов. Требуемый уровень учетной записи «%», ваш уровень «%». Повысьте уровень учетной записи в личном кабинете на mos.ru.

7.2 Метод POST billing/heckTransaction API Миллион призов

Показатель	Значение
Направление вызова	от Мосбилет к Миллион призов
Тип API	RESTfull API
Авторизация	basic
METHOD url	POST billing/heckTransaction
Атрибуты запроса метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	key	string	да	Ключ партнера	
2	chargeId	string	нет	Внутренний идентификатор транзакции партнера	 public.user_million_prizes_transaction.charge_id
Пример запроса
{
  "key": "ключ партнера",
  "chargeId": "идентификатор транзакции для проверки статуса"
}
Атрибуты тела ответа метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	execTime	string	да	Время выполнения запроса	
2	errorCode	integer	да	Код ошибки	
3	errorMessage	string	да	Сообщение об ошибке	
4	requestId	string	да	Уникальный идентификатор запроса	
5	result	array	да		
5.1	result.success	boolean	да	Признак успешного завершения	
5.2	result.reason	string	нет	Текстовое пояснение ошибки	

Пример ответа:
{
  "execTime": "0.098",
  "errorCode": 0,
  "errorMessage": "",
  "requestId": "dcafd84cea069406577904667b27f19f",
  "result": {
    "success": true,
    "reason": null
  }
}
Возможные ошибки:
Код	Текст ошибки	Комментарий
401	Ошибка авторизации	Ошибка авторизации партнёра
5225	Возникает при внутренней ошибке сервиса	
7300	Некорректный ключ	Используется неверный ключ доступа
18329	Параметр chargeId не может быть пустым	
7.3 Метод POST /billing/getUserLimitBalanceAllPoints API Миллион призов

Показатель	Значение
Направление вызова	от Мосбилет к Миллион призов
Тип API	RESTfull API
Авторизация	basic
METHOD url	POST /billing/getUserLimitBalanceAllPoints
Атрибуты запроса метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	key	string	да	Ключ партнера	
2	ssoId	string	да	Уникальный идентификатор пользователя	  sso_ticket_link.sso_id where binding_type = PURCHASER
3	accountTypes	array(string)	нет	Массив типов аккаунтов. В рамках данной СП используется только тип "theatrical"	
Пример запроса
{
    "key": "ключ партнера",
    "ssoId": "SSOID",
    "accountType": ["theatrical"]
 }
Атрибуты тела ответа метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	execTime	string	да	Время выполнения операции	
2	errorCode	integer	да	Код ошибки	
3	errorMessage	string	да	Сообщение об ошибке	
4	requestId	string	да	Идентификатор запроса	
5	result	array	да	Результат обработки	
5.1	limitPoints	number	да	Остаток баллов	
5.2	accountType	string	да	Тип счета пользователя	

Пример ответа:
{
  "execTime": "0.098",
  "errorCode": 0,
  "errorMessage": "",
  "requestId": "dcafd84cea069406577904667b27f19f",
  "result": [
    {
      "limitPoints": 3500,
      "accountType": "theatrical"
    }
  ]
}
Возможные ошибки:
Код	Текст ошибки	Комментарий
401	Ошибка авторизации	Ошибка авторизации партнёра
5225	Возникает при внутренней ошибке сервиса	
7300	Некорректный ключ	Используется неверный ключ доступа
18330	Параметр ssoId должен быть UUID	Некорректное значение переданного (ssoId)
7.4 Метод POST /cashback/precalculation API Миллион призов

Показатель	Значение
Направление вызова	от Мосбилет к Миллион призов
Тип API	RESTfull API
Авторизация	basic
METHOD url	POST /cashback/precalculation
Атрибуты запроса метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	ssoId	string	да	Уникальный идентификатор пользователя	 sso_ticket_link.sso_id where binding_type = PURCHASER
2	price[]	array	да	Массив цен элементов заказа	
2.1	id	int	да	Уникальный идентификатор элемента заказа	pos.tickets.id
2.2	price	decimal	да	Стоимость элемента заказа в рублях	pos.tickets.price
3	event	string	да	Имя события, к которому привязан кешбэк	 crm.million_prizes_settings.million_prizes_event (определяется по алгоритму в п. 8.3)
4	key	string	да	Ключ партнёра	
Пример запроса
{
    "qrCode": "SSOID",
    "price: [{“id”: “12345”,“price”: 1000}],
    "event": "event_name",
    "key": "ключ партнера",
 }
Атрибуты тела ответа метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	execTime	string	да	Время выполнения запроса	
2	errorCode	integer	да	Код ошибки	
3	errorMessage	string	да	Сообщение об ошибке	
4	requestId	string	да	Идентификатор запроса	
5	result	object	да	Результат обработки	
5.1	items	array	да	Массив элементов заказа	
5.1.1	id	string	да	Уникальный идентификатор элемента заказа	 public.user_million_prizes_cashback.item_id
5.1.2	price	number	да	Стоимость элемента заказа в рублях	
5.1.3	points	number	да	Рассчитанное значение кешбэка	 public.user_million_prizes_cashback.amount
5.2	points	number	да	Общая сумма возможного кешбэка	

Пример ответа:
{
  "execTime": "0.098",
  "errorCode": 0,
  "errorMessage": "",
  "requestId": "dcafd84cea069406577904667b27f19f",
  "result": {
    "items": [
      {
        "id": "12345",
        "price": 1000,
        "points": 100
      }
    ],
    "points": 100
  }
}
Возможные ошибки:

Код	Текст ошибки	Комментарий
401	Ошибка авторизации	Ошибка авторизации партнёра
5112	Некорректное значение переданного (ssoId)	Некорректный ssoId
5225	Возникает при внутренней ошибке сервиса	
7300	Некорректный ключ	Используется неверный ключ доступа
7302	Неизвестное событие	Переданный event не зарегистрирован для данного key
7303	Для данного event отключена возможность указывать баллы для начисления в поле points. Поле должно быть пустым.	Передача points запрещена настройками для данного event
7304	Текст начисления не может быть пустым	Если вдруг у события не был задан текст для отображения в истории (для старых событий)
7306	Вы превысили количество баллов, доступных для начисления за одну операцию.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7307	Вы превысили количество баллов, доступных для начисления за всё время.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7308	Необходимо указать параметры шаблона для текста начисления	Для указанного event отмечен флаг "Партнёр должен передавать параметры шаблона для текста начисления"
7309	Необходимо указать идентификатор начисления	Для указанного event необходимо указать chargeId, или запросить разрешение не передавать ID начисления
7310	Операция с таким идентификатором уже была проведена	Для указанного key и chargeId уже есть операция
7312	Невозможно начислить баллы! Пользователю SSOID: %s уже были ранее начислены баллы за событие: %s. Данное событие не поддерживает многоразовые начисления, возможно только однократное начисление.	Для указанного event запрещены множественные начисления (разрешено только 1 начисление) на одного пользователя
7313	Невозможно начислить баллы! Количество баллов для начисления должно быть больше 0.	
7314	Дополнительная информация о событии не заполнена	Не должно возникать таких случаев
7315	Дополнительная информация о партнёре не заполнена	Не должно возникать таких случаев
7316	Для данного event отключена возможность указывать дату начисления	
7317	Для данного event отключена возможность указывать параметры шаблона для текста начисления. Поле params должно быть пустым.	
7318	Вы превысили количество баллов, доступных для начисления за день.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7319	Вы превысили количество баллов, доступных для начисления за неделю.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7320	Вы превысили количество баллов, доступных для начисления за месяц.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7321	Необходимо указать параметр %s шаблона для текста начисления	Для указанного event отмечен флаг "Партнёр должен передавать параметры шаблона для текста начисления"
7322	Неверный формат даты начисления	должна быть в формате ISO 8601 с указанием временной зоны (например 2022-10-24T12:02:17+03:00)
7323	Вы заблокированы	Необходимо попросить разблокировать
7333	Не удалось добавить начисление в очередь	
7344	Событие неактивно	
7345	Событие недоступно из-за установленных временных рамок	
18330	Параметр ssoId должен быть uuid	Некорректный uuid
18369	Кешбэк с таким именем не найден	
18370	Превышен лимит начисления кешбэка в этом месяце	
18371	Для расчета кешбэка параметр price должен быть больше 0	
18372	Превышен лимит начисления кешбэка в этом году	
18373	Превышен лимит начислений кешбека для переданного события	
18374	Превышен дневной лимит начислений кешбека для партнера	
18375	Превышен месячный лимит начислений кешбека для партнера	
18376	Превышен лимит начислений кешбека для партнера	
18377	Кешбек для данного события выключен	
18378	Ошибка при начислении баллов. Проверьте полноту и корректность данных в личном кабинете mos.ru.
Нет данных о возрасте в личном кабинете либо не удалось их получить
18379	Ошибка при начислении баллов. Проверьте полноту и корректность данных в личном кабинете mos.ru.
Нет данных по уровню учетной записи в личном кабинете либо не удалось их получить
18380	Ошибка при начислении баллов. Требуемый уровень учетной записи «%», ваш уровень «%». Повысьте уровень учетной записи в личном кабинете на mos.ru. Требуемый возраст % лет.	
18381	Ошибка при начислении баллов. Требуемый возраст % лет.	
18384	Ошибка при начислении баллов. Требуемый уровень учетной записи «%», ваш уровень «%». Повысьте уровень учетной записи в личном кабинете на mos.ru.

7.5 Метод POST /billing/transaction API Миллион призов

Показатель	Значение
Направление вызова	от Мосбилет к Миллион призов
Тип API	RESTfull API
Авторизация	basic
METHOD url	POST /billing/transaction
Атрибуты запроса метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	key	string	Да	Ключ доступа партнера	
2	ssoid	string	Да	Уникальный идентификатор пользователя	 sso_ticket_link.sso_id where binding_type = PURCHASER
3	event	string	Да	Название события для проведения транзакции (test_mosb_rmk для списания, return.theatrical для возврата)	
4	date	string	Нет	Дата и время транзакции в формате ISO 8601 с временнóй зоной	
5	points	integer	Нет	Количество баллов, если событие позволяет задать произвольное число	 public.user_million_prizes_transaction.discount
6	chargeId	string	Нет	Внутренний идентификатор транзакции партнера	 public.user_million_prizes_transaction.charge_id
7	params	json	Нет	Дополнительные параметры партнера для отображения пользователю в истории	
7.1	title	string	Нет	Наименование проекта по которому было произведено списание или возврат баллов - будет отображаться пользователю в ЛК Миллион призов	crm.event.name
Пример запроса
{
  "key": "partner_key",
  "ssoId": "user_ssoid",
  "event": "event_name",
  "chargeId": "charge_id",
  "points": 100,
  "date": "2021-01-01T01:00:00",
  "params": {
    "title": "Название проекта"
  }
}
Атрибуты тела ответа метода
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
1	chargeId	string	Да	Внутренний ID транзакции партнёра	
2	allPoints	integer	Да	Общее количество заработанных баллов	
3	currentPoints	integer	Да	Текущее количество баллов у пользователя	
4	spentPoints	integer	Да	Количество потраченных баллов	
5	accountType	string	Да	Счёт, которому принадлежат баллы	

Пример ответа:
{
  "chargeId": "charge_id",
  "allPoints": 1000,
  "currentPoints": 500,
  "spentPoints": 500,
  "accountType": "theatrical"
}
Возможные ошибки:
Код ошибки	Текст ошибки	Комментарий
7300	Некорректный ключ	Используется неверный key
7302	Неизвестное событие	Переданный event не зарегистрирован для данного key
7303	Для данного event отключена возможность указывать баллы для начисления в поле points. Поле должно быть пустым.	Передача points запрещена настройками для данного event
7304	Текст начисления не может быть пустым	Если вдруг у события не был задан текст для отображения в истории (для старых событий)
7306	Вы превысили количество баллов, доступных для начисления за одну операцию.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7307	Вы превысили количество баллов, доступных для начисления за всё время.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7308	Необходимо указать параметры шаблона для текста начисления	Для указанного event отмечен флаг "Партнёр должен передавать параметры шаблона для текста начисления"
7309	Необходимо указать идентификатор начисления	Для указанного event необходимо указать chargeId, или запросить разрешение не передавать ID начисления
7310	Операция с таким идентификатором уже была проведена	Для указанного key и chargeId уже есть операция
7312	Невозможно начислить баллы! Пользователю SSOID: %s уже были ранее начислены баллы за событие: %s. Данное событие не поддерживает многоразовые начисления, возможно только однократное начисление.	Для указанного event запрещены множественные начисления (разрешено только 1 начисление) на одного пользователя
7313	Невозможно начислить баллы! Количество баллов для начисления должно быть больше 0.	
7314	Дополнительная информация о событии не заполнена	Не должно возникать таких случаев
7315	Дополнительная информация о партнере не заполнена	Не должно возникать таких случаев
7316	Для данного event отключена возможность указывать дату начисления	
7317	Для данного event отключена возможность указывать параметры шаблона для текста начисления. Поле params должно быть пустым.	
7318	Вы превысили количество баллов, доступных для начисления за день.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7319	Вы превысили количество баллов, доступных для начисления за неделю.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7320	Вы превысили количество баллов, доступных для начисления за месяц.	Необходимо уменьшить количество начисляемых баллов или запросить увеличение лимита
7321	Необходимо указать параметр %s шаблона для текста начисления	Для указанного event отмечен флаг "Партнёр должен передавать параметры шаблона для текста начисления"
7322	Неверный формат даты начисления	должна быть в формате ISO 8601 с указанием временной зоны (например 2022-10-24T12:02:17+03:00)
7323	Вы заблокированы	Необходимо попросить разблокировать
Описание интеграционного взаимодействия должно производиться по нижеприведенному шаблону.
Показатель	Значение
Направление вызова	
Тип API	
Авторизация	
METHOD url	
•	Описание метода
Параметры запроса 
Нумерация	Имя параметра	Тип данных	Обязательность	Описание	Расположение в БД
					

•	Формат запроса
•	Пример запроса
•	Пример ответа
•	Обработка ответа
8.    Описание алгоритма
8.1 Общий алгоритм взаимодействия Мосбилет, покупателя и Миллион призов
 
8.2 Алгоритм начисления баллов
 
8.3 Алгоритм списания баллов
 
8.4 Алгоритм определения event Миллион призов
 
8.5 Алгоритм определения максимальной скидки на заказ
 
9.    Критерии приемки

№	Наименование проверки	Порядок выполнения действий	Ожидаемый результат
1	Создание новых таблиц	Проверяется наличие и структура четырёх новых таблиц (public.mp_users, public.user_million_prizes_cashback, public.user_million_prizes_discount, public.user_million_prizes_transaction)	Все четыре таблицы успешно созданы
2	Заполнение обязательных полей	В каждую новую таблицу добавляется хотя бы одна запись через SQL-запросы, проверяются обязательность заполнения ключевых столбцов	Добавленные данные корректны
3	Работа методов начисления	Через тестовый сценарий вызывается метод /cashback/get для одного заказчика, проверка успешности вызова и правильного результата	Баллы правильно начисляются
4	Проведение проверок	Вызвать метод /billing/checkTransaction с существующим идентификатором chargeId и проверить состояние транзакции	Статус корректно обновлён
5	Получение текущего баланса	Использовать метод /billing/getUserLimitBalanceAllPoints для тестирования пользователя с известным количеством баллов	Верный баланс возвращается
6	Предварительный расчет	Послать HTTP-запрос методом POST на /cashback/precalculation с заполненным телом запроса, получить распределение начисляемых баллов	Результат содержит ожидаемое распределение
7	Корректное списание и отмена	Выполнить два сценария:
— списание баллов через /billing/transaction;
— отменить операцию через тот же метод с другим событием	Операции успешно проведены
8	Публичная доступность настроек	Создать строку в таблице crm.million_prizes_settings, убедиться, что она доступна через соответствующие запросы	Настройки видны и доступны
9	Интерфейс показывает баланс	Авторизоваться как пользователь, открыть страницу оформления заказа, проверить отображение текущего баланса	Пользователь видит правильный баланс
10	Подсчет начисленных баллов	Оформить несколько заказов разными пользователями, проверить соответствие рассчитанных бонусов и итоговых записей в базе	Данные совпадают
11	Выбор количества списываемых баллов	Испытать механизм выбора суммы списывания (с помощью ползунка или аналогичного компонента). Убедиться, что выбранная сумма влияет на конечную цену билета	Цена изменяется соответственно выбору
12	Распределение скидок по билетам	Совершить покупку нескольких билетов одним заказом, применить скидку через баллы, удостовериться, что сумма скидки распределяется между всеми элементами заказа	Сумма скидки корректна
10. ERD и описание атрибутов
Новая таблица public.mp_users
№	Название поля в системе	Атрибут	Тип	Размер	Обязательность	Ограничение
1	Идентификатор записи	id	int		YES	Первичный ключ
2	Уникальный идентификатор пользователя	sso_id	nvarchar	255	YES	Уникальное значение
3	Баланс баллов пользователя	balance	int		NO	
4	Признак согласия на участие в программе лояльности	has_agreement	boolean		YES	
Новая таблица public.user_million_prizes_cashback
№	Название поля в системе	Атрибут	Тип	Размер	Обязательность	Ограничение
1	Идентификатор записи	id	int		YES	Первичный ключ
2	Ссылка на пользователя	mp_user_id	int		YES	Внешний ключ (public.mp_users)
3	Элемент заказа	item_id	int		YES	
4	Идентификатор заказа	order_id	int		YES	
5	Сумма начисляемых/списываемых баллов	amount	int		YES	Положительное число
6	Дата и время добавления локально	date_added_local	datetime		YES	Текущая дата-время сервера
7	Статус операции	state	nvarchar	255	YES	Возможные значения: 'NEW', 'ADDED', 'CANCELED'
8	Дата завершения операции начисления	date_added_mp	datetime		NO	Заполняется при успешном выполнении операции
9	Тип элемента заказа	item_type	nvarchar	255	YES	IN (TICKET, PROVIDER, RENTAL_PROVIDER, PRODUCT, MEMBERSHIP_TICKET, EXCURSION_TICKET)
10	UUID транзакции начисления/списывания баллов	charge_id	nvarchar	255	YES	
Новая таблица public.user_million_prizes_discount
№	Название поля в системе	Атрибут	Тип	Размер	Обязательность	Ограничение
1	Идентификатор записи	id	int		YES	Первичный ключ
2	Связь с транзакцией	user_million_prizes_transaction_id	int		YES	Внешний ключ (public.user_million_prizes_transaction)
3	Пользователь Million Prizes	mp_user_id	int		YES	Внешний ключ (public.mp_users)
4	Элемент заказа	item_id	int		YES	
5	Идентификатор заказа	order_id	int		YES	
6	Полная цена до скидок	full_price	decimal		YES	Положительная денежная величина
7	Цена после учёта скидки	price	decimal		YES	Денежная величина >= 0
8	Величина скидки	discount	decimal		YES	Денежная величина >= 0
9	Дата и время добавления	date_added_local	datetime		YES	
10	Статус	state	nvarchar	255	YES	Возможные значения: 'ADDED', 'CANCELED'
11	Тип элемента заказа	item_type	nvarchar	255	YES	IN (TICKET, PROVIDER, RENTAL_PROVIDER, PRODUCT, MEMBERSHIP_TICKET, EXCURSION_TICKET)
Новая таблица public.user_million_prizes_transaction
№	Название поля в системе	Атрибут	Тип	Размер	Обязательность	Ограничение
1	Идентификатор записи	id	int		YES	Первичный ключ
2	Пользователь Million Prizes	mp_user_id	int		YES	Внешний ключ (public.mp_users)
3	Номер заказа	order_id	int		YES	
4	Полная стоимость заказа до скидки	full_price	decimal		YES	Положительная денежная величина
5	Стоимость заказа после скидки	price	decimal		YES	Денежная величина >= 0
6	Общая сумма скидки по всему заказу	discount	decimal		YES	Денежная величина >= 0
7	Дата и время добавления записи	date_added_local	datetime		YES	
8	Статус	state	nvarchar	255	YES	Возможные значения: 'ADDED', 'CANCELED'
9	UUID транзакции	charge_id	nvarchar	255	YES	Уникальный идентификатор транзакции
Новая таблица crm.million_prizes_settings
№	Название поля в системе	Атрибут	Тип	Размер	Обязательность	Ограничение
1	Идентификатор записи	id	int		YES	Первичный ключ
2	ID объекта (учреждение, мероприятие, событие)	item_id	int		YES	
3	Тип объекта	item_type	int		YES	Возможные значения: MUSEUM, EVENT, PERFORMANCE
4	Event Миллиона Призов для начисления баллов	million_prizes_event	varchar		NO	Настройка начисления баллов (в рамках данной СП устанавливаем cashback_mosbilet на уровне учреждений)
5	Максимальная скидка в процентах за счёт баллов на заказ	max_discount	int		NO	Процентное ограничение максимальной скидки на заказ (в рамках данной СП устанавливаем 20% на уровне учреждений)
ERD:
 
11. Связанные объекты/ссылки
 UPBDEV-1453 - Лояльность: Миллион призов Подготовка СП 



