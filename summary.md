# Текущее состояние проекта NER Controller

Проект представляет собой Python FastAPI‑сервис для извлечения сущностей (NER) и проверки «галлюцинаций» в ответах LLM. Сервис работает на порту 1304 и имеет OpenAPI‑документацию по адресу http://localhost:1304/docs. Архитектура построена по слоям (API / Application / Domain / Infrastructure) с жёстким правилом «один файл — один класс» и зависимостями снизу вверх. Ключевые интерфейсы доменного слоя описаны через абстракции EntityExtractorInterface и EmbeddingGeneratorInterface, а бизнес‑логика собирается в application_factory.

Функционально реализованы три основных API‑сценария. Эндпоинт `/hallucination/check` сравнивает сущности, найденные в запросе и ответе, и возвращает два списка: `potential_hallucinations` (есть в ответе, но нет в запросе) и `missing_entities` (есть в запросе, но нет в ответе). Эндпоинт `/file/process` принимает base64‑кодированный текстовый файл, режет его на чанки с перекрытием, извлекает сущности гибридно (GLiNER + regex) и генерирует эмбеддинги для каждого чанка через локальный OpenAI‑совместимый сервер (LM Studio). Эндпоинт `/text/process` обрабатывает один текст без чанкинга и возвращает сущности и один эмбеддинг. Во всех сценариях используется дедупликация сущностей на базе регистронезависимого сравнения и расстояния Левенштейна (порог ≤ 2). Поддерживается предпочтительное поле `entity_types` и легаси‑алиас `entities_types`.

Модель NER — `urchade/gliner_multi-v2.1` (включая базовый `microsoft/mdeberta-v3-base`), предусмотрен режим оффлайн‑загрузки через локальный кэш HuggingFace и принудительный `local_files_only=True`. Эмбеддинги получаютcя через модель `text-embedding-qwen3-embedding-8b` в LM Studio. В README подробно описаны требования: Python 3.12, виртуальное окружение `venv/`, запуск `uvicorn`, автозапуск через supervisor в WSL, а также сценарии тестирования (unit, integration, e2e). В проекте фиксированы зависимости в `requirements.txt`, ведётся журнал в `logs/`, и присутствуют шаблоны документации в `templates/`.

Документация фиксирует архитектуру и недавние изменения. В `IMPLEMENTATION_SUMMARY.md` и `docs/text_processing_architecture.md` отражена архитектура эндпоинта `/text/process`, включая поток данных, роли слоёв и стратегию обработки ошибок. В `docs/ner_offline_architecture.md` описан оффлайн‑режим для GLiNER. Корневые документы `README.md` и `llm_readme.md` содержат инструкции по запуску, тестам, архитектурным принципам и ключевым интерфейсам. Дополнительные правила разработки собраны в `AGENTS.md` и `project_rules.md`, включая порядок работы (архитектура → тесты → реализация), требования к тестовому покрытию, ограничения по размеру функций/классов, обязательные docstring, правила именования и безопасности.

Текущее состояние можно считать функционально завершённым для заявленных сценариев: реализованы маршруты, конфигурации, слои, тестовый набор и документация по архитектуре. При этом часть логики ориентирована на локальную инфраструктуру (LM Studio), что требует корректных параметров подключения и наличия моделей в кэше. Также важно отслеживать соответствие документации фактическому коду при любом изменении (например, имена полей, формат ответа, значения по умолчанию).

Документацию необходимо регулярно обновлять при любых изменениях кода, схем, зависимостей и поведения API. Это требование зафиксировано в правилах проекта и должно выполняться после каждого изменения, чтобы README‑файлы и LLM‑документы оставались актуальными.
